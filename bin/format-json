#!/usr/bin/env ruby

require 'optparse'
require 'json_better_formatter'
require 'json_better_formatter/version'

opts = OptionParser.new do |opts|
  opts.banner = "Usage: format-json [options]Â [FILE]"
  opts.separator "Standard input is read when FILE is not present"
  opts.separator ""

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end

  opts.on_tail("-v", "--version", "Print the version number of format-json") do
    puts "format-json #{JsonBetterFormatter::VERSION}"
    exit
  end
end

opts.parse!

Signal.trap("INT") do
  puts "Aborted"
  exit 1
end

Signal.trap("TERM") do
  puts "Aborted"
  exit 1
end

begin
  if ARGV.empty?
    JsonBetterFormatter.new(in: STDIN).format
  else
    JsonBetterFormatter.new(in: ARGF).format
  end
rescue JsonBetterFormatter::UnparseableError => e
  $stderr.puts e
  exit! 1
rescue Errno::EPIPE
  # Do nothing
end
